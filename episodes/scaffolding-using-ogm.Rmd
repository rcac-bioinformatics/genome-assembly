---
title: 'Scaffolding using Optical Genome Mapping'
teaching: 20
exercises: 20
---

:::::::::::::::::::::::::::::::::::::: questions 

- What is Bionano optical genome mapping (OGM) and how does it improve genome assembly?
- How does Bionano Solve hybrid scaffolding integrate optical maps with sequence assemblies?
- What are the key steps involved in running the Bionano Solve pipeline for hybrid scaffolding?
- How can you assess the quality of hybrid scaffolds generated by Bionano Solve?



::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Understand the principles of Bionano optical genome mapping (OGM) and its role in genome assembly.
- Learn how to run the Bionano Solve hybrid scaffolding pipeline to improve genome assemblies.
- Explore the key steps involved in scaffolding HiFiasm and Flye assemblies using Bionano Solve.
- Evaluate the quality of hybrid scaffolds generated by Bionano Solve and interpret the results.

::::::::::::::::::::::::::::::::::::::::::::::::

## Introduction to Bionano optical genome mapping (OGM)

Bionano optical mapping is a high-resolution genome analysis technique that generates long-range structural information by labeling and imaging ultra-long DNA molecules. It provides genome-wide maps that can be used to scaffold contigs from sequencing-based assemblies, significantly improving contiguity and structural accuracy. By integrating Bionano maps with assemblies from PacBio HiFi and Oxford Nanopore Technologies (ONT), misassemblies can be corrected, chimeric contigs resolved, and scaffold N50s increased by orders of magnitude. This approach is particularly valuable for complex genomes, where repetitive sequences and structural variations pose challenges for traditional sequencing methods. Bionano hybrid scaffolding has become a standard for enhancing genome assemblies, enabling researchers to achieve high-quality, chromosome-level assemblies efficiently.


![Overview of Bionano OGM](https://github.com/user-attachments/assets/41c7c42b-c5e0-4d0d-b899-a479e62ffaee){alt="Diagram showing the Bionano optical genome mapping process from DNA labeling to genome-wide maps"}


## Bionano Solve Hybrid Scaffolding

Bionano Solve improves genome assembly by integrating optical genome mapping data with sequence assemblies, generating ultra-long hybrid scaffolds that enhance contiguity and accuracy. The pipeline identifies and resolves assembly conflicts, orders and orients sequence contigs, and estimates gap sizes between adjacent sequences.

The scaffolding workflow involves:

1. In Silico Map Generation – Converting sequence assembly into a map format for alignment.
2. Conflict Resolution – Aligning in silico maps to Bionano genome maps and identifying misassemblies.
3. Hybrid Scaffolding – Merging high-confidence sequence and optical maps into a refined scaffold.
4. Final Alignment – Mapping sequence contigs back to the hybrid scaffold for consistency validation.
5. Output Generation – Producing final AGP and FASTA files with corrected genome structures.


![Scaffolding using Bionano](https://github.com/user-attachments/assets/e568386e-348d-4b18-82ca-e304369f0fed){alt="Workflow diagram of Bionano Solve hybrid scaffolding pipeline showing in silico map generation, conflict resolution, and scaffold assembly"}




**What is the source of this data?**

- The optical genome mapping data was obtained from the project [PRJEB50694](https://www.ebi.ac.uk/ena/browser/view/PRJEB50694).  
- Data corresponds to _Arabidopsis thaliana_ ecotype Col-0, generated using Bionano optical genome mapping technology.  
- The dataset is publicly available on the European Nucleotide Archive (ENA) and can be downloaded using:  
- The `.cmap` file contains high-resolution optical maps used for scaffolding and structural validation of genome assemblies.

To download:


```bash
wget ftp://ftp.sra.ebi.ac.uk/vol1/analysis/ERZ227/ERZ2272299/Evry.OpticalMap.Col-0.cmap.gz
gunzip Evry.OpticalMap.Col-0.cmap.gz
```



## Installation and Setup  


Bionano Solve is available on Bionano.com and can be installed on Linux-based systems. The software requires a valid license and access to Bionano data files for processing. 

Custom container with just the hybrid scaffolding tools can be used to run the Bionano Solve pipeline. On Negishi, you can add it to your PATH using the command below:

```bash
export PATH=$PATH:/apps/biocontainers/exported-wrappers/bionano/3.8.0
```

## Running Bionano Solve

To scaffold a genome using Bionano Solve, you need to provide the following input files:

```bash
export PATH=$PATH:/apps/biocontainers/exported-wrappers/bionano/3.8.0
run_hybridscaffold.sh \
  -c /opt/Solve3.7_10192021_74_1/HybridScaffold/1.0/hybridScaffold_DLE1_config.xml \
  -b input.cmap \
  -n genome.fasta \
  -u CTTAAG \
  -z results_output.zip \
  -w log.txt \
  -B 2 \
  -N 2 \
  -g \
  -f \
  -r /opt/Solve3.7_10192021_74_1/RefAligner/1.0/sse/RefAligner \
  -p /opt/Solve3.7_10192021_74_1/Pipeline/1.0 \
  -o output_dir
```

::: callout

## Options used


| **Option** | **Argument** | **Description** |
|:-:|:----|----------------|
| `-c` | `/opt/Solve3.7_10192021_74_1/HybridScaffold/1.0/hybridScaffold_DLE1_config.xml` | Specifies the hybrid scaffolding configuration file required for the pipeline. |
| `-b` | `input.cmap` | Input Bionano CMAP file, which contains the optical genome map data. |
| `-n` | `genome.fasta` | Input genome sequence in FASTA format from NGS assembly. |
| `-u` | `CTTAAG` | Specifies the sequence of the enzyme recognition site, overriding the one in the config XML file. |
| `-z` | `results_output.zip` | Generates a ZIP archive containing essential output files. |
| `-w` | `log.txt` | Defines the name of the status text file needed for IrysView. |
| `-B` | `2` | Conflict filter level: `2` means cut the contig at conflict points (required if not using `-M`). |
| `-N` | `2` | Conflict filter level: `2` means cut the contig at conflict points (same as `-B`, applied to sequencing contigs). |
| `-g` | (No argument) | Enables trimming of overlapping NGS sequences during AGP and FASTA export. |
| `-f` | (No argument) | Forces output generation and overwrites any existing files in the output directory. |
| `-r` | `/opt/Solve3.7_10192021_74_1/RefAligner/1.0/sse/RefAligner` | Specifies the path to the RefAligner program, which is required for scaffolding. |
| `-p` | `/opt/Solve3.7_10192021_74_1/Pipeline/1.0` | Specifies the directory for the de novo assembly pipeline (optional, required for `-x`). |
| `-o` | `output_dir` | Defines the output folder where scaffolded results will be stored. |

:::


### Scaffolding HiFiasm assembly with Bionano Solve

For HiFiasm assembly, you need to provide the HiFiasm assembly FASTA file as input to the Bionano Solve pipeline. The command structure remains the same, with the only change being the input sequence file.

```bash
export PATH=$PATH:/apps/biocontainers/exported-wrappers/bionano/3.8.0
run_hybridscaffold.sh \
  -c /opt/Solve3.7_10192021_74_1/HybridScaffold/1.0/hybridScaffold_DLE1_config.xml\
  -b Evry.OpticalMap.Col-0.cmap \
  -n ../02_pacbio-hifi/hifiasm_default/At_hifiasm_default.asm.bp.p_ctg.fasta \
  -u CTTAAG \
  -z results_bionano_hifiasm_scaffolding.zip \
  -w log.txt \
  -B 2 \
  -N 2 \
  -g \
  -f \
  -r /opt/Solve3.7_10192021_74_1/RefAligner/1.0/sse/RefAligner \
  -p /opt/Solve3.7_10192021_74_1/Pipeline/1.0 \
  -o bionano_hifiasm_scaffolding
```



### Scaffolding Flye assembly with Bionano Solve


For Flye assembly, the process is similar to HiFiasm, but you need to provide the Flye assembly FASTA file instead of the HiFiasm assembly. The command structure remains the same, with the only change being the input sequence file.

```bash
export PATH=$PATH:/apps/biocontainers/exported-wrappers/bionano/3.8.0
run_hybridscaffold.sh \
  -c /opt/Solve3.7_10192021_74_1/HybridScaffold/1.0/hybridScaffold_DLE1_config.xml\
  -b Evry.OpticalMap.Col-0.cmap \
  -n ../03_ont-assembly/flye_ont/assembly.fasta \
  -u CTTAAG \
  -z results_bionano_flye_scaffolding.zip \
  -w log.txt \
  -B 2 \
  -N 2 \
  -g \
  -f \
  -r /opt/Solve3.7_10192021_74_1/RefAligner/1.0/sse/RefAligner \
  -p /opt/Solve3.7_10192021_74_1/Pipeline/1.0 \
  -o bionano_flye_scaffolding
```

## Understanding Hybrid Scaffolding Output

The output of the Bionano Solve pipeline includes scaffolded genome assemblies in AGP and FASTA formats, along with alignment and conflict resolution information. The hybrid scaffolds provide a more accurate representation of the genome structure, with improved contiguity and reduced misassemblies. The output files can be visualized using genome browsers or alignment viewers to assess the quality and completeness of the assembly.

| **Folder** | **Contents** |
|------------|-------------|
| **agp_fasta/** | Final scaffolded genome assembly in FASTA, AGP format, alignment results, gap information, and logs. |
| **align0/** | Initial alignment of optical maps to the sequence assembly, including XMAP, CMAP, and error logs. |
| **align1/** | Secondary alignment refinement, similar to align0 but after resolving initial inconsistencies. |
| **align_final/** | Final alignment results of hybrid scaffolds to optical maps, including mapping rates and statistics. |
| **assignAlignType/** | Tracks conflicts between NGS contigs and optical maps, includes exclusion and trimming decisions. |
| **cut_conflicts/** | Stores files related to contig trimming and conflict resolution between NGS and optical maps. |
| **fa2cmap/** | Converts the sequence assembly into Bionano’s CMAP format before integration with optical maps. |
| **hybrid_scaffolds/** | Contains final scaffolded genome with CMAP, XMAP, AGP files, and a scaffolding report. |
| **mergeNGS_BN/** | Stores intermediate files merging NGS contigs with Bionano maps, including hybrid scaffold progress. |
| **results_output.zip** | Compressed archive containing essential scaffolding results for easy sharing. |


Within `hybrid_scaffolds`, the files ending with `HYBRID_SCAFFOLD_NCBI.fasta` and `HYBRID_SCAFFOLD_NOT_SCAFFOLDED.fasta` represent the final scaffolded genome and unplaced contigs, respectively.
You will need to merge these files to obtain your final scaffolded genome assembly:

```bash
# For the HiFiasm scaffolded assembly:
cat bionano_hifiasm_scaffolding/hybrid_scaffolds/*HYBRID_SCAFFOLD_NCBI.fasta \
    bionano_hifiasm_scaffolding/hybrid_scaffolds/*HYBRID_SCAFFOLD_NOT_SCAFFOLDED.fasta \
    > hifiasm_bionano_scaffolded.fasta

# For the Flye scaffolded assembly:
cat bionano_flye_scaffolding/hybrid_scaffolds/*HYBRID_SCAFFOLD_NCBI.fasta \
    bionano_flye_scaffolding/hybrid_scaffolds/*HYBRID_SCAFFOLD_NOT_SCAFFOLDED.fasta \
    > flye_bionano_scaffolded.fasta
```


## Quality Assessment of Hybrid Scaffolds


The hybrid scaffolds report file will be in the `hybrid_scaffolds` directory and will provide a summary of the scaffolding process, including alignment statistics, conflict resolution, and scaffold N50 values. This report is essential for evaluating the quality and completeness of the hybrid scaffolds and identifying any potential issues that need further investigation.

| **Category**                                  | **PacBio HiFi (hifiasm)**   | **ONT (Flye)**    |
|:--------------------------------------------|-------------:|-------------:|
| **Original BioNano Genome Map**             |              |              |
| Count                                        | 18           | 18           |
| Min length (Mbp)                             | 0.342        | 0.342        |
| Median length (Mbp)                          | 3.956        | 3.956        |
| Mean length (Mbp)                            | 7.396        | 7.396        |
| N50 length (Mbp)                             | 15.529       | 15.529       |
| Max length (Mbp)                             | 17.518       | 17.518       |
| Total length (Mbp)                           | 133.124      | 133.124      |
| **Original NGS Sequences**                   |              |              |
| Count                                        | 146          | 50           |
| Min length (Mbp)                             | 0.027        | 0.007        |
| Median length (Mbp)                          | 0.050        | 0.132        |
| Mean length (Mbp)                            | 0.930        | 2.575        |
| N50 length (Mbp)                             | 7.981        | 11.822       |
| Max length (Mbp)                             | 13.758       | 15.517       |
| Total length (Mbp)                           | 135.747      | 128.743      |
| **Conflict Resolution (BNG-NGS Alignment)**  |              |              |
| Conflict cuts made to Bionano maps           | 2            | 0            |
| Conflict cuts made to NGS sequences          | 30           | 1            |
| Bionano maps to be cut                       | 2            | 0            |
| NGS sequences to be cut                      | 18           | 1            |
| **NGS FASTA Sequence in Hybrid Scaffold**    |              |              |
| Count                                        | 41           | 21           |
| Min length (Mbp)                             | 0.033        | 0.064        |
| Median length (Mbp)                          | 0.936        | 3.272        |
| Mean length (Mbp)                            | 2.633        | 5.797        |
| N50 length (Mbp)                             | 8.437        | 11.250       |
| Max length (Mbp)                             | 13.484       | 15.517       |
| Total length (Mbp)                           | 107.968      | 121.743      |
| **Hybrid Scaffold FASTA**                    |              |              |
| Count                                        | 10           | 12           |
| Min length (Mbp)                             | 4.083        | 0.129        |
| Median length (Mbp)                          | 13.162       | 12.662       |
| Mean length (Mbp)                            | 11.601       | 10.164       |
| N50 length (Mbp)                             | 14.479       | 15.517       |
| Max length (Mbp)                             | 15.229       | 17.656       |
| Total length (Mbp)                           | 116.011      | 121.972      |
| **Hybrid Scaffold FASTA + Not Scaffolded NGS** |            |              |
| Count                                        | 153          | 43           |
| Min length (Mbp)                             | 0.024        | 0.000        |
| Median length (Mbp)                          | 0.050        | 0.135        |
| Mean length (Mbp)                            | 0.940        | 2.999        |
| N50 length (Mbp)                             | 14.052       | 15.517       |
| Max length (Mbp)                             | 15.229       | 17.656       |
| Total length (Mbp)                           | 143.790      | 128.972      |

::: callout

## Which assembler and data performed better?

- The Flye ONT assembly produced **fewer conflict cuts** (1 NGS cut vs 30 for HiFiasm), indicating better structural agreement with the optical map.
- Flye + Bionano achieved a **higher scaffold N50** (15.517 Mbp vs 14.479 Mbp) and **larger scaffold max** (17.656 Mbp vs 15.229 Mbp).
- HiFiasm + Bionano retained more total sequence (143.790 Mbp vs 128.972 Mbp), partly due to haplotig duplications inflating the total.
- Both assemblies have 5 chromosome-scale scaffolds (evidenced by high N50 values close to Arabidopsis chromosome sizes).

:::

::::::::::::::::::::::::::::::::::::: keypoints 


- Bionano optical genome mapping (OGM) provides long-range structural information for scaffolding genome assemblies.
- Bionano Solve hybrid scaffolding integrates optical maps with sequence assemblies to improve contiguity and accuracy.
- The Bionano Solve pipeline involves in silico map generation, conflict resolution, hybrid scaffolding, and final alignment.
- The output of Bionano Solve includes scaffolded genome assemblies in AGP and FASTA formats, alignment results, and conflict resolution information.
- Quality assessment of hybrid scaffolds involves evaluating alignment statistics, conflict resolution, scaffold N50 values, and completeness of the assembly.


::::::::::::::::::::::::::::::::::::::::::::::::

